<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Found Blocks - P2Pool Salvium</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css">
</head>
<body class="dark">
    <div class="content center">
        <nav style="margin-bottom: 2rem; text-align: center;">
            <a href="/" class="nav-item">Home</a> |
            <a href="." class="nav-item">Stats</a> |
            <a href="blocks.html" class="nav-item">Blocks</a> |
            <a href="shares.html" class="nav-item">Shares</a> |
            <a href="miners.html" class="nav-item">Miners</a> |
            <a href="calculator.html" class="nav-item">Calculator</a> |
            <a href="instructions.html" class="nav-item">Get Started</a>
        </nav>

        <h1 style="text-align: center; margin-bottom: 2rem;">Found Blocks</h1>

        <div class="stats-grid" style="margin-bottom: 2rem;">
            <div class="stat-card">
                <h3>Total Found</h3>
                <div class="value" id="total-found">--</div>
            </div>
            <div class="stat-card">
                <h3>Last 24h</h3>
                <div class="value" id="blocks-24h">--</div>
            </div>
            <div class="stat-card">
                <h3>Current / Avg Effort</h3>
                <div class="value" id="effort-display">--</div>
            </div>
            <div class="stat-card">
                <h3>Last Block</h3>
                <div class="value" id="last-block">--</div>
            </div>
        </div>

        <div id="blocks-container">
            <div class="loading">Loading...</div>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        async function load() {
            const [blocks, poolInfo] = await Promise.all([
                API.getFoundBlocks(100),
                API.getPoolInfo()
            ]);
            const blockReward = poolInfo?.block_reward;
            const container = document.getElementById('blocks-container');

            if (!blocks || blocks.length === 0) {
                container.innerHTML = '<p>No blocks found yet</p>';
                return;
            }

            // Sort by height ascending first to calculate effort
            blocks.sort((a, b) => (a.height || 0) - (b.height || 0));

            // Calculate effort for each block (round_hashes = current - previous total_hashes)
            for (let i = 0; i < blocks.length; i++) {
                if (i === 0) {
                    blocks[i].effort = null;
                } else {
                    const prevHashes = parseFloat(blocks[i-1].total_hashes || 0);
                    const currHashes = parseFloat(blocks[i].total_hashes || 0);
                    const roundHashes = currHashes - prevHashes;
                    const diff = parseFloat(blocks[i].difficulty || 1);
                    blocks[i].effort = (roundHashes / diff) * 100;
                }
            }

            // Reverse for display (newest first)
            blocks.reverse();

            // Stats
            const now = Date.now() / 1000;
            const blocks24h = blocks.filter(b => b.timestamp && (now - b.timestamp) < 86400).length;

            document.getElementById('total-found').textContent = blocks.length;
            document.getElementById('blocks-24h').textContent = blocks24h;

            // Calculate average effort from last 50 blocks (skip first which has no effort)
            let totalEffort = 0;
            let effortCount = 0;
            const recentBlocks = blocks.slice(0, 50); // newest 50 (already reversed)
            for (const block of recentBlocks) {
                if (block.effort !== null) {
                    totalEffort += block.effort;
                    effortCount++;
                }
            }
            const currentEffort = poolInfo?.effort?.current_effort ?? poolInfo?.effort?.current ?? poolInfo?.current_effort;
            if (effortCount > 0) {
                const avgEffort = (totalEffort / effortCount).toFixed(1);
                if (currentEffort !== undefined) {
                    document.getElementById('effort-display').textContent = currentEffort.toFixed(1) + '% / ' + avgEffort + '%';
                } else {
                    document.getElementById('effort-display').textContent = '-- / ' + avgEffort + '%';
                }
            }

            // Last block time
            if (blocks.length > 0 && blocks[0].timestamp) {
                document.getElementById('last-block').textContent = Utils.timeAgo(blocks[0].timestamp);
            }

            let html = '<table class="data-table"><thead><tr><th>Salvium Height</th><th>Finder</th><th>Reward</th><th>Effort</th><th>Age</th></tr></thead><tbody>';
            for (const block of blocks) {
                const height = block.height || block.main_height || '--';
                const effort = block.effort !== null ? block.effort.toFixed(1) + '%' : '--';
                const reward = block.reward || blockReward;
                const finder = block.finder || '--';
                html += `<tr id="block-${height}">
                    <td data-label="Height"><a href="block.html?height=${height}">${height}</a></td>
                    <td data-label="Finder" class="mono">${finder}</td>
                    <td data-label="Reward">${reward ? Utils.formatSALShort(reward) : '--'}</td>
                    <td data-label="Effort">${effort}</td>
                    <td data-label="Age">${block.timestamp ? Utils.timeAgo(block.timestamp) : '--'}</td>
                </tr>`;
            }
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        load();
        startAutoRefresh(load, 60000);
    </script>
</body>
</html>
